apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard
  namespace: team4project3
data:
  dashboard_provider.yaml: |-
    apiVersion: 1
    providers:
      - name: "Default"
        orgId: 1
        folder: ""
        type: file
        disableDeletion: false
        editable: true
        updateIntervalSeconds: 10
        options:
          path: /etc/grafana/provisioning/dashboards
  monitoring.json: |-
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": 18,
      "links": [],
      "panels": [
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "color": { "mode": "palette-classic" },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "barWidthFactor": 0.6,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": { "type": "linear" },
                "showPoints": "auto",
                "showValues": false,
                "spanNulls": false,
                "stacking": { "group": "A", "mode": "none" },
                "thresholdsStyle": { "mode": "off" }
              },
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "id": 1,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(cl_http_request_duration_seconds_bucket[5m])) by (le, route))",
              "legendFormat": "{{route}}",
              "refId": "A"
            }
          ],
          "title": "API Request Duration (p95)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "reqps",
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 5, "w": 11, "x": 12, "y": 0 },
          "id": 2,
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] },
            "textMode": "auto"
          },
          "targets": [
            { "expr": "sum(cl_http_requests_active)", "legendFormat": "Active Requests", "refId": "A" }
          ],
          "title": "Active HTTP Requests",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 5, "w": 11, "x": 12, "y": 5 },
          "id": 8,
          "options": {
            "colorMode": "value",
            "reduceOptions": { "calcs": ["lastNotNull"] },
            "textMode": "auto"
          },
          "targets": [
            { "expr": "avg(cl_pod_health_status)", "legendFormat": "Health Status", "refId": "A" }
          ],
          "title": "Pod Health",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "reqps",
              "color": { "mode": "palette-classic" },
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
          "id": 3,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true }
          },
          "targets": [
            {
              "expr": "sum(rate(cl_http_errors_total[5m])) by (status_code)",
              "legendFormat": "Status {{status_code}}",
              "refId": "A"
            }
          ],
          "title": "HTTP Error Rate",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "none",
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 6, "w": 11, "x": 12, "y": 10 },
          "id": 4,
          "options": { "orientation": "auto" },
          "targets": [
            { "expr": "cl_db_connection_pool_size", "legendFormat": "{{state}}", "refId": "A" }
          ],
          "title": "DB Connection Pool (Idle vs Total)",
          "type": "gauge"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "color": { "mode": "palette-classic" },
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 16 },
          "id": 5,
          "targets": [
            {
              "expr": "rate(cl_db_query_duration_seconds_sum[5m]) / rate(cl_db_query_duration_seconds_count[5m])",
              "legendFormat": "{{operation}}",
              "refId": "A"
            }
          ],
          "title": "DB Query Duration (avg over 5m)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "color": { "mode": "palette-classic" },
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 7, "w": 11, "x": 12, "y": 16 },
          "id": 9,
          "targets": [
            { "expr": "cl_app_uptime_seconds", "legendFormat": "Uptime (s)", "refId": "A" }
          ],
          "title": "App Uptime",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "bytes",
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 6, "w": 12, "x": 0, "y": 23 },
          "id": 7,
          "targets": [
            {
              "expr": "cl_nodejs_memory_usage_bytes",
              "legendFormat": "{{type}}",
              "refId": "A"
            }
          ],
          "title": "Memory Usage (RSS, Heap)",
          "type": "bargauge"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 6, "w": 11, "x": 12, "y": 23 },
          "id": 10,
          "targets": [
            {
              "expr": "rate(cl_spatial_query_duration_seconds_sum[5m]) / rate(cl_spatial_query_duration_seconds_count[5m])",
              "legendFormat": "{{query_type}}",
              "refId": "A"
            }
          ],
          "title": "Spatial Query Duration",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "color": { "mode": "palette-classic" },
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "green", "value": 0 }, { "color": "red", "value": 80 }]
              }
            }
          },
          "gridPos": { "h": 5, "w": 6, "x": 0, "y": 29 },
          "id": 6,
          "targets": [
            {
              "expr": "rate(cl_blob_upload_duration_seconds_sum[5m]) / rate(cl_blob_upload_duration_seconds_count[5m])",
              "legendFormat": "Upload Duration",
              "refId": "A"
            }
          ],
          "title": "Blob Upload Duration (avg over 5m)",
          "type": "timeseries"
        }
      ],
      "schemaVersion": 42,
      "time": { "from": "now-6h", "to": "now" },
      "title": "Application Monitoring Dashboard",
      "uid": "ab8d2e38-e303-44d7-9c9e-bedd8cebe577",
      "version": 8
    }
